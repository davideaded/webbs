<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Webbs</title>
        <link rel="stylesheet" href="/main.css">
    </head>
    <body>
        <%- include("navbar", {  }) %>
        <% if (user) { %>
        <div class="greetings">
            <h1 class="welcome">Welcome, <%= user.username %>!</h1>
            <a class="btn new" href="/messages/new"> New message </a>
        </div>
        <% } %>

        <div class="container">
            <% if (messages) { %>
                <% messages.forEach(m => { %>
                <%- include("message", { m, user }) %>
                <% }) %>
            <% } %>
        </div>
    </body>
    <script defer>
        document.addEventListener("DOMContentLoaded", () => {
        const delBtns = document.querySelectorAll(".delete-btn");
        delBtns.forEach((btn) => {
            btn.addEventListener("click", async () => {
                const id = btn.dataset.id;
                const confirmDelete = confirm("Confirm delete?");
                if (confirmDelete) {
                    try {
                        const res = await fetch(`/messages/${id}`, {
                            method: "DELETE",
                        });
                        if (res.ok) {
                            btn.closest(".message").remove();
                        }

                    } catch (err) {
                        console.error(err);
                    }
                }
            });
        });
    });
    </script>
</html>
